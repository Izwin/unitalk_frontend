import 'package:json_annotation/json_annotation.dart';
import 'package:unitalk/features/block/data/model/block_model.dart';
import 'package:unitalk/features/faculty/data/models/faculty_model.dart';
import 'package:unitalk/features/university/data/models/university_model.dart';
import 'verification_model.dart';

part 'user_model.g.dart';

enum Sector {
  @JsonValue('en')
  english,
  @JsonValue('ru')
  russian,
  @JsonValue('az')
  azerbaijani;

  String get code {
    switch (this) {
      case Sector.english:
        return 'en';
      case Sector.russian:
        return 'ru';
      case Sector.azerbaijani:
        return 'az';
    }
  }

  String get displayName {
    switch (this) {
      case Sector.english:
        return 'English';
      case Sector.russian:
        return 'Russian';
      case Sector.azerbaijani:
        return 'Azerbaijani';
    }
  }

  String get flagEmoji {
    switch (this) {
      case Sector.english:
        return 'üá¨üáß';
      case Sector.russian:
        return 'üá∑üá∫';
      case Sector.azerbaijani:
        return 'üá¶üáø';
    }
  }

  static Sector? fromCode(String? code) {
    if (code == null) return null;
    switch (code) {
      case 'en':
        return Sector.english;
      case 'ru':
        return Sector.russian;
      case 'az':
        return Sector.azerbaijani;
      default:
        return null;
    }
  }
}

@JsonSerializable()
class UserModel {
  @JsonKey(name: '_id')
  final String? id;
  final String? email;
  final String? photoUrl;
  final String? firstName;
  final String? lastName;
  @JsonKey(name: 'universityId')
  final UniversityModel? university;
  @JsonKey(name: 'facultyId')
  final FacultyModel? faculty;
  final Sector? sector;
  final bool? isVerified;
  @JsonKey(name: 'verificationId')
  final VerificationModel? verification;
  final BlockStatusModel? blockStatus;
  final int? friendsCount;
  final int? pendingRequestsCount;

  // –ù–û–í–û–ï: –Ø–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
  final String? language;

  UserModel({
    required this.id,
    this.email,
    this.photoUrl,
    this.firstName,
    this.lastName,
    this.university,
    this.faculty,
    this.sector,
    this.isVerified,
    this.verification,
    this.blockStatus,
    this.friendsCount,
    this.pendingRequestsCount,
    this.language, // –ù–û–í–û–ï
  });

  factory UserModel.fromJson(Map<String, dynamic> json) =>
      _$UserModelFromJson(json);

  Map<String, dynamic> toJson() => _$UserModelToJson(this);

  bool get isProfileComplete =>
      firstName != null &&
          lastName != null &&
          university != null &&
          faculty != null &&
          sector != null;

  bool get canInteract => blockStatus?.canInteract ?? true;
  bool get isBlocked => blockStatus?.isBlocked ?? false;
  bool get isBlockedBy => blockStatus?.isBlockedBy ?? false;
}// features/auth/presentation/pages/profile_page.dart

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_bloc.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_event.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_state.dart';
import 'package:unitalk/features/auth/presentation/widget/profile_drawer.dart';
import 'package:unitalk/features/auth/presentation/widget/student_id_card_widget.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_bloc.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_event.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_state.dart';
import 'package:unitalk/features/feed/presentation/widget/post_item.dart';
import 'package:unitalk/features/friendship/presentation/widgets/friends_count_button.dart';
import 'package:unitalk/l10n/app_localizations.dart';

import 'widget/verification_status_widget.dart';

const double _kDrawerBreakpoint = 600.0;
const double _kDrawerWidth = 300.0;

class ProfilePage extends StatelessWidget {
  const ProfilePage({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return _ProfilePageContent();
  }
}

class _ProfilePageContent extends StatefulWidget {
  @override
  State<_ProfilePageContent> createState() => _ProfilePageContentState();
}

class _ProfilePageContentState extends State<_ProfilePageContent> {
  late final ScrollController _scrollController;  // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω

  String? get _currentUserId => context.read<AuthBloc>().state.user?.id;

  @override
  void initState() {
    super.initState();

    // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ScrollController
    _scrollController = ScrollController();
    _scrollController.addListener(_onScroll);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    _loadPosts(page: 1);
  }

  @override
  void dispose() {
    _scrollController.removeListener(_onScroll);
    _scrollController.dispose();
    super.dispose();
  }

  // ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫—Ä–æ–ª–ª–∞
  void _onScroll() {
    if (_isBottom) {
      _loadMorePosts();
    }
  }

  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∫–æ–Ω—Ü–∞ —Å–ø–∏—Å–∫–∞
  bool get _isBottom {
    if (!_scrollController.hasClients) return false;
    final maxScroll = _scrollController.position.maxScrollExtent;
    final currentScroll = _scrollController.offset;
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–≥–¥–∞ –¥–æ –∫–æ–Ω—Ü–∞ –æ—Å—Ç–∞–ª–æ—Å—å 200 –ø–∏–∫—Å–µ–ª–µ–π
    return currentScroll >= (maxScroll - 200);
  }

  // ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
  void _loadPosts({required int page}) {
    final userId = _currentUserId;
    if (userId == null) return;

    context.read<PostBloc>().add(
      GetPostsEvent(
        authorId: userId,
        page: page,
      ),
    );
  }

  // ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  void _loadMorePosts() {
    final postState = context.read<PostBloc>().state;

    // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏:
    // - —É–∂–µ –∏–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∞
    // - –¥–æ—Å—Ç–∏–≥–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (postState.status == PostStatus.loading ||
        postState.isLoadingMore ||
        postState.postsLastPage) {
      return;
    }

    final userId = _currentUserId;
    if (userId == null) return;

    print('üìÑ Loading page ${postState.postsPage}'); // Debug

    context.read<PostBloc>().add(
      GetPostsEvent(
        authorId: userId,
        page: postState.postsPage,
      ),
    );
  }

  Future<void> _onRefresh() async {
    final userId = _currentUserId;
    if (userId == null) return;

    context.read<PostBloc>().add(GetPostsEvent(authorId: userId, page: 1));
    context.read<AuthBloc>().add(GetCurrentUserEvent());
  }

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final isWide = screenWidth >= _kDrawerBreakpoint;

    if (isWide) {
      return Scaffold(
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
        body: Row(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            SizedBox(
              width: _kDrawerWidth,
              child: ProfileDrawer(),
            ),
            VerticalDivider(width: 1, thickness: 1),
            Expanded(
              child: _buildContent(context, isWide: true),
            ),
          ],
        ),
      );
    }

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      endDrawer: ProfileDrawer(),
      body: _buildContent(context, isWide: false),
    );
  }

  Widget _buildContent(BuildContext context, {required bool isWide}) {
    final l10n = AppLocalizations.of(context)!;

    return BlocBuilder<AuthBloc, AuthState>(
      builder: (context, authState) {
        final user = authState.user;

        if (user == null) {
          return const Center(child: CircularProgressIndicator());
        }

        return RefreshIndicator(
          onRefresh: _onRefresh,
          color: Theme.of(context).colorScheme.primary,
          backgroundColor: Theme.of(context).colorScheme.surface,
          child: CustomScrollView(
            controller: _scrollController,  // ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
            physics: const AlwaysScrollableScrollPhysics(),
            slivers: [
              // ‚îÄ‚îÄ‚îÄ AppBar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              SliverAppBar(
                expandedHeight: 0,
                pinned: false,
                backgroundColor: Colors.transparent,
                elevation: 0,
                title: Text(l10n.profile),
                actions: [
                  IconButton(
                    icon: const Icon(Icons.edit_outlined),
                    tooltip: l10n.editProfile,
                    onPressed: () => context.push('/edit-profile'),
                  ),
                  if (!isWide)
                    IconButton(
                      icon: const Icon(Icons.menu),
                      onPressed: () => Scaffold.of(context).openEndDrawer(),
                    ),
                ],
              ),

              // ‚îÄ‚îÄ‚îÄ Profile header section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              SliverPadding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                sliver: SliverList(
                  delegate: SliverChildListDelegate([
                    StudentIdCardWidget(user: user),
                    const SizedBox(height: 16),

                    Row(
                      children: [
                        Expanded(
                          child: StatCountButton(
                            count: user.friendsCount ?? 0,
                            label: l10n.friends,
                            icon: Icons.people_outlined,
                            onTap: () => context.push('/friends'),
                          ),
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: StatCountButton(
                            count: user.pendingRequestsCount ?? 0,
                            label: l10n.friendRequests,
                            icon: Icons.person_add_outlined,
                            highlightThreshold: 1,
                            onTap: () => context.push('/friend-requests'),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 20),

                    VerificationStatusWidget(user: user),
                    const SizedBox(height: 24),

                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Text(
                          l10n.myPosts,
                          style: const TextStyle(
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        BlocBuilder<PostBloc, PostState>(
                          builder: (context, state) {
                            return Text(
                              l10n.postsCount(state.totalPostsCount),
                              style: TextStyle(
                                fontSize: 14,
                                color: Theme.of(context)
                                    .textTheme
                                    .bodySmall
                                    ?.color
                                    ?.withOpacity(0.6),
                              ),
                            );
                          },
                        ),
                      ],
                    ),
                  ]),
                ),
              ),

              // ‚îÄ‚îÄ‚îÄ Posts List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              BlocBuilder<PostBloc, PostState>(
                builder: (context, state) {
                  if (state.status == PostStatus.loading &&
                      state.posts.isEmpty) {
                    return const SliverFillRemaining(
                      child: Center(child: CircularProgressIndicator()),
                    );
                  }

                  if (state.posts.isEmpty) {
                    return SliverFillRemaining(
                      child: Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(
                              Icons.article_outlined,
                              size: 64,
                              color: Theme.of(context)
                                  .textTheme
                                  .bodySmall
                                  ?.color
                                  ?.withOpacity(0.3),
                            ),
                            const SizedBox(height: 16),
                            Text(
                              l10n.noPostsYet,
                              style: TextStyle(
                                fontSize: 16,
                                color: Theme.of(context)
                                    .textTheme
                                    .bodySmall
                                    ?.color
                                    ?.withOpacity(0.6),
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  }

                  return SliverList(
                    delegate: SliverChildBuilderDelegate(
                          (context, index) {
                        // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞
                        if (index == state.posts.length) {
                          return _buildLoadingIndicator(state);
                        }
                        return PostItem(post: state.posts[index]);
                      },
                      // ‚úÖ +1 –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
                      childCount: state.posts.length + (state.postsLastPage ? 0 : 1),
                    ),
                  );
                },
              ),

              const SliverPadding(padding: EdgeInsets.only(bottom: 40)),
            ],
          ),
        );
      },
    );
  }

  // ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω–∏–∑—É —Å–ø–∏—Å–∫–∞
  Widget _buildLoadingIndicator(PostState state) {
    if (state.postsLastPage) {
      return const SizedBox.shrink();
    }

    return Container(
      padding: const EdgeInsets.symmetric(vertical: 16),
      alignment: Alignment.center,
      child: state.status == PostStatus.loading || state.isLoadingMore
          ? const CircularProgressIndicator()
          : TextButton(
        onPressed: _loadMorePosts,
        child: const Text('–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë'),
      ),
    );
  }
}import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';
import 'package:unitalk/core/ui/common/bottom_sheet_list_picker.dart';
import 'package:unitalk/core/ui/common/common_text_field.dart';
import 'package:unitalk/core/ui/common/confirmation_dialog.dart';
import 'package:unitalk/core/ui/common/image_source_picker.dart';
import 'package:unitalk/core/ui/common/selector_card.dart';
import 'package:unitalk/core/ui/common/university_selection_sheet.dart';
import 'package:unitalk/core/ui/common/user_avatar.dart';
import 'package:unitalk/features/auth/data/model/user_model.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_bloc.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_event.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_state.dart';
import 'package:unitalk/features/faculty/data/models/faculty_model.dart';
import 'package:unitalk/features/university/data/models/university_model.dart';
import 'package:unitalk/features/university/presentation/manager/university_bloc.dart';
import 'package:unitalk/features/university/presentation/manager/university_event.dart';
import 'package:unitalk/features/university/presentation/manager/university_state.dart';
import 'package:unitalk/l10n/app_localizations.dart';
import 'package:unitalk/l10n/bloc/locale_cubit.dart';

class EditProfilePage extends StatefulWidget {
  const EditProfilePage({Key? key}) : super(key: key);

  @override
  State<EditProfilePage> createState() => _EditProfilePageState();
}

class _EditProfilePageState extends State<EditProfilePage> {
  final _formKey = GlobalKey<FormState>();

  late TextEditingController _firstNameController;
  late TextEditingController _lastNameController;

  UniversityModel? _selectedUniversity;
  FacultyModel? _selectedFaculty;
  Sector? _selectedSector;
  File? _selectedImage;

  bool _isModified = false;
  bool _universityChanged = false;
  bool _facultyChanged = false;

  @override
  void initState() {
    super.initState();
    final user = context.read<AuthBloc>().state.user!;

    _firstNameController = TextEditingController(text: user.firstName);
    _lastNameController = TextEditingController(text: user.lastName);

    _selectedUniversity = user.university;
    _selectedFaculty = user.faculty;
    _selectedSector = user.sector;

    _firstNameController.addListener(_onFieldChanged);
    _lastNameController.addListener(_onFieldChanged);

    if (_selectedUniversity != null) {
      context.read<UniversityBloc>().add(
        LoadFacultiesEvent(_selectedUniversity!.id),
      );
    }
  }

  @override
  void dispose() {
    _firstNameController.dispose();
    _lastNameController.dispose();
    super.dispose();
  }

  void _onFieldChanged() {
    if (!_isModified) {
      setState(() => _isModified = true);
    }
  }

  Future<void> _handleImageSelection() async {
    final l10n = AppLocalizations.of(context)!;
    final user = context.read<AuthBloc>().state.user;

    final image = await MediaSourcePicker.show(
      context,
      galleryText: l10n.chooseFromGallery,
      videoText: l10n.video,
      cameraText: l10n.takePhoto,
      removeText: l10n.removePhoto,
      canRemove: _selectedImage != null || user?.photoUrl != null,
      onRemove: () {
        setState(() {
          _selectedImage = null;
          _isModified = true;
        });
      },
    );

    if (image != null) {
      setState(() {
        _selectedImage = File(image.path);
        _isModified = true;
      });
    }
  }

// –í EditProfilePage –∑–∞–º–µ–Ω–∏—Ç–µ –º–µ—Ç–æ–¥ _showUniversityPicker –Ω–∞ —ç—Ç–æ—Ç:

  Future<void> _showUniversityPicker(BuildContext context) async {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (modalContext) => BlocProvider.value(
        value: context.read<UniversityBloc>(),
        child: BlocProvider.value(
          value: context.read<LocaleCubit>(),
          child: UniversitySelectionSheet(
            currentUniversity: _selectedUniversity,
            onUniversitySelected: (university) {
              final user = context.read<AuthBloc>().state.user!;
              final willLoseVerification = user.isVerified == true &&
                  user.university?.id != university.id;

              void selectUniversity() {
                setState(() {
                  _selectedUniversity = university;
                  _selectedFaculty = null;
                  _isModified = true;
                  _universityChanged = user.university?.id != university.id;
                });
                context.read<UniversityBloc>().add(
                  LoadFacultiesEvent(university.id),
                );
                Navigator.pop(modalContext); // –ó–∞–∫—Ä—ã–≤–∞–µ–º bottom sheet
              }

              if (willLoseVerification) {
                Navigator.pop(modalContext); // –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º sheet
                _showVerificationWarning(selectUniversity, context);
              } else {
                selectUniversity();
              }
            },
          ),
        ),
      ),
    );
  }

  Future<void> _showFacultyPicker(BuildContext context) async {
    final l10n = AppLocalizations.of(context)!;
    final locale = context.read<LocaleCubit>().state.languageCode;

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (_) => BlocBuilder<UniversityBloc, UniversityState>(
        builder: (_, state) {
          return BottomSheetListPicker<FacultyModel>(
            title: l10n.selectFaculty,
            items: state.faculties,
            selectedItem: _selectedFaculty,
            itemTitle: (faculty) => faculty.getLocalizedName(locale),
            defaultIcon: Icons.account_balance,
            customFilter: (faculty, query) => faculty.matchesQuery(query),
            onItemSelected: (faculty) {
              final user = context.read<AuthBloc>().state.user!;
              final willLoseVerification = user.isVerified == true &&
                  user.faculty?.id != faculty.id;

              void selectFaculty() {
                setState(() {
                  _selectedFaculty = faculty;
                  _isModified = true;
                  _facultyChanged = user.faculty?.id != faculty.id;
                });
              }

              if (willLoseVerification) {
                _showVerificationWarning(selectFaculty, context);
              } else {
                context.pop();
                selectFaculty();
              }
            },
            searchHint: l10n.searchFaculties,
            emptyMessage: l10n.noFacultiesFound,
          );
        },
      ),
    );
  }
  Future<void> _showSectorPicker() async {
    final l10n = AppLocalizations.of(context)!;

    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        margin: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Theme.of(context).scaffoldBackgroundColor,
          borderRadius: BorderRadius.circular(24),
        ),
        child: SafeArea(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              SizedBox(height: 8),
              Container(
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey.shade300,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              SizedBox(height: 20),
              Padding(
                padding: EdgeInsets.symmetric(horizontal: 20),
                child: Row(
                  children: [
                    Text(
                      l10n.selectSector,
                      style: TextStyle(
                        fontSize: 22,
                        fontWeight: FontWeight.w700,
                      ),
                    ),
                    Spacer(),
                    IconButton(
                      icon: Icon(Icons.close),
                      onPressed: () => context.pop(),
                      style: IconButton.styleFrom(
                        backgroundColor: Colors.grey.shade100,
                        shape: CircleBorder(),
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(height: 12),
              ...Sector.values.map((sector) {
                final isSelected = _selectedSector == sector;
                return Padding(
                  padding: EdgeInsets.symmetric(horizontal: 20, vertical: 4),
                  child: RadioSelectorItem(
                    title: sector.displayName,
                    isSelected: isSelected,
                    icon: Icons.language,
                    onTap: () {
                      setState(() {
                        _selectedSector = sector;
                        _isModified = true;
                      });
                      context.pop();
                    },
                  ),
                );
              }).toList(),
              SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }

  Future<void> _showVerificationWarning(VoidCallback onConfirm,BuildContext context) async {
    final l10n = AppLocalizations.of(context)!;

    final confirmed = await ConfirmationDialog.showVerificationWarning(
      context,
      l10n.verificationWarningTitle,
      l10n.verificationWarningMessage,
      l10n.continueButton,
      l10n.cancel,
    );

    if (confirmed) {
      onConfirm();
    }
  }

  void _saveChanges(BuildContext context) async {
    if (!_formKey.currentState!.validate()) return;

    final user = context.read<AuthBloc>().state.user!;
    final willLoseVerification = user.isVerified == true &&
        (_universityChanged || _facultyChanged);

    void performSave() async {
      if (_selectedImage != null) {
        context.read<AuthBloc>().add(UpdateAvatarEvent(_selectedImage!));
        await Future.delayed(Duration(milliseconds: 500));
      }

      context.read<AuthBloc>().add(
        UpdateProfileEvent(
          firstName: _firstNameController.text.trim(),
          lastName: _lastNameController.text.trim(),
          universityId: _selectedUniversity?.id,
          facultyId: _selectedFaculty?.id,
          sector: _selectedSector,
        ),
      );
      context.pop();
    }

    if (willLoseVerification) {
      _showVerificationWarning(performSave,context);
    } else {
      performSave();
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    final theme = Theme.of(context);
    final user = context.read<AuthBloc>().state.user!;
    final locale = context.read<LocaleCubit>().state.languageCode;

    return BlocListener<AuthBloc, AuthState>(
      listener: (context, state) {
        if (state.status == AuthStatus.failure) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(state.errorMessage ?? l10n.failedToUpdateProfile),
              backgroundColor: Colors.red.shade400,
              behavior: SnackBarBehavior.floating,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(12),
              ),
            ),
          );
        }
      },
      child: Scaffold(
        backgroundColor: theme.scaffoldBackgroundColor,
        appBar: AppBar(
          elevation: 0,
          backgroundColor: Colors.transparent,
          leading: IconButton(
            icon: Icon(Icons.arrow_back),
            onPressed: () => context.pop(),
          ),
          title: Text(
            l10n.editProfile,
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
            ),
          ),
          actions: [
            if (_isModified)
              Padding(
                padding: EdgeInsets.only(right: 8),
                child: TextButton(
                  onPressed: () => _saveChanges(context),
                  style: TextButton.styleFrom(
                    backgroundColor: theme.primaryColor,
                    foregroundColor: Colors.white,
                    padding: EdgeInsets.symmetric(horizontal: 20),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: Text(
                    l10n.save,
                    style: TextStyle(
                      fontSize: 15,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
          ],
        ),
        body: Form(
          key: _formKey,
          child: ListView(
            padding: EdgeInsets.all(20),
            children: [
              // Avatar Section
              Center(
                child: Stack(
                  children: [
                    UserAvatar(
                      photoUrl: _selectedImage != null
                          ? null
                          : user.photoUrl,
                      firstName: user.firstName,
                      lastName: user.lastName,
                      size: 120,
                    ),
                    if (_selectedImage != null)
                      Container(
                        width: 120,
                        height: 120,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                        ),
                        child: ClipOval(
                          child: Image.file(
                            _selectedImage!,
                            fit: BoxFit.cover,
                          ),
                        ),
                      ),
                    Positioned(
                      bottom: 0,
                      right: 0,
                      child: GestureDetector(
                        onTap: _handleImageSelection,
                        child: Container(
                          width: 40,
                          height: 40,
                          decoration: BoxDecoration(
                            color: theme.primaryColor,
                            shape: BoxShape.circle,
                            border: Border.all(
                              color: theme.scaffoldBackgroundColor,
                              width: 3,
                            ),
                            boxShadow: [
                              BoxShadow(
                                color: Colors.black.withOpacity(0.1),
                                blurRadius: 8,
                                offset: Offset(0, 2),
                              ),
                            ],
                          ),
                          child: Icon(
                            Icons.photo_camera,
                            color: Colors.white,
                            size: 20,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(height: 32),

              // Personal Information
              _buildSectionTitle(l10n.personalInformation),
              SizedBox(height: 12),
              CommonTextField(
                controller: _firstNameController,
                label: l10n.firstName,
                icon: Icons.person_outline,
                validator: (value) {
                  if (value?.trim().isEmpty ?? true) {
                    return l10n.firstNameRequired;
                  }
                  return null;
                },
              ),
              SizedBox(height: 12),
              CommonTextField(
                controller: _lastNameController,
                label: l10n.lastName,
                icon: Icons.person_outline,
                validator: (value) {
                  if (value?.trim().isEmpty ?? true) {
                    return l10n.lastNameRequired;
                  }
                  return null;
                },
              ),

              SizedBox(height: 32),

              // Academic Information
              _buildSectionTitle(l10n.academicInformation),
              SizedBox(height: 12),
              SelectorCard(
                label: l10n.university,
                value: _selectedUniversity?.getLocalizedName(locale) ?? l10n.selectUniversityPrompt,
                icon: Icons.school_outlined,
                onTap: ()=>_showUniversityPicker(context),
              ),
              SizedBox(height: 12),
              SelectorCard(
                label: l10n.faculty,
                value: _selectedFaculty?.getLocalizedName(locale) ?? l10n.selectFacultyPrompt,
                icon: Icons.account_balance_outlined,
                onTap: () => _showFacultyPicker(context),
                isEnabled: _selectedUniversity != null,
              ),
              SizedBox(height: 12),
              SelectorCard(
                label: l10n.sector,
                value: _selectedSector?.displayName ?? l10n.selectSectorPrompt,
                icon: Icons.language_outlined,
                onTap: _showSectorPicker,
              ),
              SizedBox(height: 32),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSectionTitle(String title) {
    return Text(
      title,
      style: TextStyle(
        fontSize: 12,
        fontWeight: FontWeight.w600,
        color: Colors.grey.shade600,
        letterSpacing: 0.5,
      ),
    );
  }
}

class RadioSelectorItem extends StatelessWidget {
  final String title;
  final bool isSelected;
  final IconData? icon;
  final VoidCallback onTap;

  const RadioSelectorItem({
    Key? key,
    required this.title,
    required this.isSelected,
    this.icon,
    required this.onTap,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: isSelected
              ? theme.primaryColor.withOpacity(0.08)
              : theme.cardColor,
          border: Border.all(
            color: isSelected
                ? theme.primaryColor
                : Colors.grey.shade200,
            width: isSelected ? 2 : 1,
          ),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Row(
          children: [
            if (icon != null)
              Container(
                width: 48,
                height: 48,
                decoration: BoxDecoration(
                  color: theme.primaryColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Icon(
                  icon,
                  color: theme.primaryColor,
                  size: 24,
                ),
              ),
            if (icon != null) SizedBox(width: 16),
            Expanded(
              child: Text(
                title,
                style: TextStyle(
                  fontSize: 15,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
            if (isSelected)
              Container(
                width: 28,
                height: 28,
                decoration: BoxDecoration(
                  color: theme.primaryColor,
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  Icons.check,
                  color: Colors.white,
                  size: 16,
                ),
              ),
          ],
        ),
      ),
    );
  }
}import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:unitalk/core/di/service_locator.dart';
import 'package:unitalk/core/ui/common/report_dialog.dart';
import 'package:unitalk/features/auth/data/model/user_model.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_bloc.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_state.dart';
import 'package:unitalk/features/block/presentation/bloc/block_bloc.dart';
import 'package:unitalk/features/block/presentation/bloc/block_event.dart';
import 'package:unitalk/features/block/presentation/bloc/block_state.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_bloc.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_event.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_state.dart';
import 'package:unitalk/features/feed/presentation/bloc/user_profile/user_profile_bloc.dart';
import 'package:unitalk/features/feed/presentation/bloc/user_profile/user_profile_event.dart';
import 'package:unitalk/features/feed/presentation/bloc/user_profile/user_profile_state.dart';
import 'package:unitalk/features/feed/presentation/widget/post_item.dart';
import 'package:unitalk/features/auth/presentation/widget/student_id_card_widget.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_bloc.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_event.dart';
import 'package:unitalk/features/friendship/presentation/widgets/friends_count_button.dart';
import 'package:unitalk/features/friendship/presentation/widgets/friendship_button.dart';
import 'package:unitalk/features/report/data/model/report_model.dart';
import 'package:unitalk/l10n/app_localizations.dart';

class OtherUserProfileScreen extends StatefulWidget {
  final String userId;

  const OtherUserProfileScreen({Key? key, required this.userId})
      : super(key: key);

  @override
  State<OtherUserProfileScreen> createState() => _OtherUserProfileScreenState();
}

class _OtherUserProfileScreenState extends State<OtherUserProfileScreen> {
  late ScrollController _scrollController;

  @override
  void initState() {
    super.initState();
    _scrollController = ScrollController();
    _scrollController.addListener(_onScroll);

    context.read<UserProfileBloc>().add(GetUserProfileEvent(widget.userId));
    context.read<PostBloc>().add(
      GetPostsEvent(authorId: widget.userId, page: 1, limit: 20),
    );
    context.read<FriendshipBloc>().add(LoadFriendshipStatusEvent(widget.userId));
    context.read<BlockBloc>().add(CheckBlockStatusEvent(widget.userId));
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  Future<void> _onRefresh() async {
    context.read<UserProfileBloc>().add(GetUserProfileEvent(widget.userId));
    context.read<BlockBloc>().add(CheckBlockStatusEvent(widget.userId));
    context.read<PostBloc>().add(
      GetPostsEvent(authorId: widget.userId, page: 1, limit: 20),
    );
    context.read<FriendshipBloc>().add(LoadFriendshipStatusEvent(widget.userId));


    await context.read<UserProfileBloc>().stream.firstWhere(
          (state) => !state.isLoading,
    );
  }

  void _onScroll() {
    if (_scrollController.position.pixels ==
        _scrollController.position.maxScrollExtent) {
      final postState = context.read<PostBloc>().state;

      if (!postState.postsLastPage && !postState.isLoadingMore) {
        context.read<PostBloc>().add(
          GetPostsEvent(
            authorId: widget.userId,
            page: postState.postsPage + 1,
            limit: 20,
          ),
        );
      }
    }
  }

  // ‚îÄ‚îÄ‚îÄ –ú–æ–¥–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é (3 —Ç–æ—á–∫–∏) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  void _showModerationMenu(BuildContext context, UserModel user) {
    final l10n = AppLocalizations.of(context)!;
    final blockStatus = user.blockStatus;

    showModalBottomSheet(
      context: context,
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (sheetContext) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Handle
            Container(
              margin: const EdgeInsets.only(top: 12, bottom: 20),
              width: 40,
              height: 4,
              decoration: BoxDecoration(
                color: Theme.of(context).dividerColor,
                borderRadius: BorderRadius.circular(2),
              ),
            ),

            // Block / Unblock
            if (blockStatus?.isBlocked == true)
              ListTile(
                leading: const Icon(Icons.block, color: Colors.red),
                title: Text(l10n.unblockUser),
                onTap: () {
                  Navigator.pop(sheetContext);
                  _showUnblockDialog(context, widget.userId, user);
                },
              )
            else if (blockStatus?.isBlockedBy != true)
              ListTile(
                leading: const Icon(Icons.block, color: Colors.red),
                title: Text(l10n.blockUser),
                onTap: () {
                  Navigator.pop(sheetContext);
                  _showBlockDialog(context, widget.userId, user);
                },
              ),

            // Report
            if (blockStatus?.isBlockedBy != true)
              ListTile(
                leading: const Icon(Icons.flag_outlined),
                title: Text(l10n.report),
                onTap: () {
                  Navigator.pop(sheetContext);
                  ReportDialog.show(
                    context,
                    targetType: ReportTargetType.user,
                    targetId: widget.userId,
                  );
                },
              ),

            const SizedBox(height: 12),
          ],
        ),
      ),
    );
  }

  void _showBlockDialog(BuildContext context, String userId, UserModel user) {
    final l10n = AppLocalizations.of(context)!;

    showDialog(
      context: context,
      builder: (dialogContext) => AlertDialog(
        title: Text(l10n.blockUser),
        content: Text(
          l10n.blockUserConfirmation('${user.firstName} ${user.lastName}'),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(dialogContext),
            child: Text(l10n.cancel),
          ),
          FilledButton(
            onPressed: () {
              context.read<BlockBloc>().add(BlockUserEvent(userId));
              Navigator.pop(dialogContext);
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text(l10n.userBlocked)),
              );
            },
            style: FilledButton.styleFrom(backgroundColor: Colors.red),
            child: Text(l10n.block),
          ),
        ],
      ),
    );
  }

  void _showUnblockDialog(
      BuildContext context,
      String userId,
      UserModel user,
      ) {
    final l10n = AppLocalizations.of(context)!;

    showDialog(
      context: context,
      builder: (dialogContext) => AlertDialog(
        title: Text(l10n.unblockUser),
        content: Text(
          l10n.unblockUserConfirmation('${user.firstName} ${user.lastName}'),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(dialogContext),
            child: Text(l10n.cancel),
          ),
          FilledButton(
            onPressed: () {
              context.read<BlockBloc>().add(UnblockUserEvent(userId));
              Navigator.pop(dialogContext);
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text(l10n.userUnblocked)),
              );
            },
            child: Text(l10n.unblock),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: BlocBuilder<UserProfileBloc, UserProfileState>(
        builder: (context, profileState) {
          // ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if (profileState.isLoading && profileState.user == null) {
            return const Center(child: CircularProgressIndicator());
          }

          // ‚îÄ‚îÄ‚îÄ Error ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          if (profileState.errorMessage != null &&
              profileState.user == null) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.error_outline,
                    size: 64,
                    color: Theme.of(context)
                        .textTheme
                        .bodySmall
                        ?.color
                        ?.withOpacity(0.3),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    l10n.errorMessage(profileState.errorMessage ?? ''),
                    style: TextStyle(
                      fontSize: 16,
                      color: Theme.of(context)
                          .textTheme
                          .bodySmall
                          ?.color
                          ?.withOpacity(0.6),
                    ),
                  ),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: () {
                      context.read<UserProfileBloc>().add(
                        GetUserProfileEvent(widget.userId),
                      );
                    },
                    child: Text(l10n.tryAgain),
                  ),
                ],
              ),
            );
          }

          // ‚îÄ‚îÄ‚îÄ User not found ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          final user = profileState.user;
          if (user == null) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.person_off_outlined,
                    size: 64,
                    color: Theme.of(context)
                        .textTheme
                        .bodySmall
                        ?.color
                        ?.withOpacity(0.3),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    l10n.userNotFound,
                    style: TextStyle(
                      fontSize: 16,
                      color: Theme.of(context)
                          .textTheme
                          .bodySmall
                          ?.color
                          ?.withOpacity(0.6),
                    ),
                  ),
                ],
              ),
            );
          }

          // ‚îÄ‚îÄ‚îÄ Main content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          return BlocBuilder<PostBloc, PostState>(
            builder: (context, postState) {
              return RefreshIndicator(
                onRefresh: _onRefresh,
                color: Theme.of(context).colorScheme.primary,
                backgroundColor: Theme.of(context).colorScheme.surface,
                child: CustomScrollView(
                  controller: _scrollController,
                  physics: const AlwaysScrollableScrollPhysics(),
                  slivers: [
                    // ‚îÄ‚îÄ‚îÄ AppBar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    SliverAppBar(
                      expandedHeight: 0,
                      pinned: false,
                      backgroundColor: Colors.transparent,
                      elevation: 0,
                      title: Text(l10n.profile),
                      leading: IconButton(
                        icon: const Icon(Icons.arrow_back),
                        onPressed: () => context.pop(),
                      ),
                      actions: [
                        BlocBuilder<AuthBloc, AuthState>(
                          builder: (context, authState) {
                            if (authState.user?.id == widget.userId) {
                              return const SizedBox.shrink();
                            }
                            return IconButton(
                              icon: const Icon(Icons.more_vert),
                              onPressed: () =>
                                  _showModerationMenu(context, user),
                            );
                          },
                        ),
                      ],
                    ),

                    // ‚îÄ‚îÄ‚îÄ Profile header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    SliverPadding(
                      padding: const EdgeInsets.all(20),
                      sliver: SliverList(
                        delegate: SliverChildListDelegate([
                          // –°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞
                          StudentIdCardWidget(user: user),
                          const SizedBox(height: 16),

                          // ‚îÄ‚îÄ‚îÄ –î—Ä—É–∑—å—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                          if (user.friendsCount != null &&
                              user.friendsCount! > 0)
                            StatCountButton(
                              count: profileState.user?.friendsCount ?? 0,
                              label: l10n.friends,
                              icon: Icons.people_outlined,
                              onTap: () => context.push('/user/${ profileState.user?.id}/friends'),
                            ),

                          const SizedBox(height: 14),

                          // ‚îÄ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ –¥—Ä—É–∂–±—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                          FriendshipButton(userId: widget.userId),
                          const SizedBox(height: 24),

                          // ‚îÄ‚îÄ‚îÄ Posts header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                          Row(
                            mainAxisAlignment:
                            MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                l10n.posts,
                                style: const TextStyle(
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              Text(
                                l10n.postsCount(postState.totalPostsCount),
                                style: TextStyle(
                                  fontSize: 14,
                                  color: Theme.of(context)
                                      .textTheme
                                      .bodySmall
                                      ?.color
                                      ?.withOpacity(0.6),
                                ),
                              ),
                            ],
                          ),
                        ]),
                      ),
                    ),

                    // ‚îÄ‚îÄ‚îÄ Posts List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (postState.posts.isEmpty && postState.status != PostStatus.loading)
                      SliverFillRemaining(
                        child: Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(
                                Icons.article_outlined,
                                size: 64,
                                color: Theme.of(context)
                                    .textTheme
                                    .bodySmall
                                    ?.color
                                    ?.withOpacity(0.3),
                              ),
                              const SizedBox(height: 16),
                              Text(
                                l10n.userHasNoPosts,
                                textAlign: TextAlign.center,
                                style: TextStyle(
                                  fontSize: 16,
                                  color: Theme.of(context)
                                      .textTheme
                                      .bodySmall
                                      ?.color
                                      ?.withOpacity(0.6),
                                ),
                              ),
                            ],
                          ),
                        ),
                      )
                    else
                      SliverList(
                        delegate: SliverChildBuilderDelegate(
                              (context, index) {
                            return PostItem(post: postState.posts[index]);
                          },
                          childCount: postState.posts.length,
                        ),
                      ),

                    // ‚îÄ‚îÄ‚îÄ Loading more ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (postState.isLoadingMore)
                      const SliverToBoxAdapter(
                        child: Padding(
                          padding: EdgeInsets.all(16),
                          child: Center(child: CircularProgressIndicator()),
                        ),
                      ),

                    const SliverPadding(
                      padding: EdgeInsets.only(bottom: 40),
                    ),
                  ],
                ),
              );
            },
          );
        },
      ),
    );
  }
}import 'dart:io';
import 'package:dio/dio.dart';
import 'package:unitalk/features/auth/data/model/user_model.dart';

class UserRemoteDataSource {
  final Dio dio;

  UserRemoteDataSource({required this.dio});

  Future<UserModel> getCurrentUser() async {
    try {
      final response = await dio.get('/auth/me');
      return UserModel.fromJson(response.data);
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }

  Future<UserModel> getUserById(String userId) async {
    try {
      final response = await dio.get('/auth/$userId');
      return UserModel.fromJson(response.data);
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }

  Future<UserModel> updateProfile({
    required String firstName,
    required String lastName,
    required String universityId,
    required String facultyId,
    required String sector,
    String? language,
  }) async {
    try {
      final data = {
        'firstName': firstName,
        'lastName': lastName,
        'universityId': universityId,
        'facultyId': facultyId,
        'sector': sector,
      };

      if (language != null) {
        data['language'] = language;
      }

      final response = await dio.put('/auth/profile', data: data);
      return UserModel.fromJson(response.data);
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }

  Future<UserModel> updateLanguage(String language) async {
    try {
      final response = await dio.put(
        '/auth/profile',
        data: {'language': language},
      );
      return UserModel.fromJson(response.data);
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }

  Future<String> updateAvatar({required File file}) async {
    try {
      final formData = FormData.fromMap({
        'avatar': await MultipartFile.fromFile(file.path, filename: 'avatar.jpg'),
      });

      final response = await dio.post('/auth/avatar', data: formData);
      return response.data['photoUrl'] as String;
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }

  Future<void> deleteProfile() async {
    try {
      await dio.delete('/auth/profile');
    } on DioException catch (e) {
      throw _handleDioError(e);
    }
  }

  String _handleDioError(DioException error) {
    switch (error.type) {
      case DioExceptionType.connectionTimeout:
      case DioExceptionType.sendTimeout:
      case DioExceptionType.receiveTimeout:
        return 'Connection timeout. Please check your internet connection.';

      case DioExceptionType.connectionError:
        if (error.error is SocketException) {
          return 'No internet connection. Please check your network.';
        }
        return 'Connection error. Please check your internet connection.';

      case DioExceptionType.badResponse:
        final statusCode = error.response?.statusCode;
        if (statusCode == 401) {
          return 'Session expired. Please login again.';
        } else if (statusCode == 403) {
          return 'Access denied.';
        } else if (statusCode == 404) {
          return 'Resource not found.';
        } else if (statusCode != null && statusCode >= 500) {
          return 'Server error. Please try again later.';
        }
        return error.response?.data?['message'] ?? 'Request failed.';

      case DioExceptionType.cancel:
        return 'Request cancelled.';

      case DioExceptionType.unknown:
        if (error.error is SocketException) {
          return 'No internet connection. Please check your network.';
        }
        return 'An unexpected error occurred.';

      default:
        return 'An error occurred. Please try again.';
    }
  }
}import 'dart:io';
import 'package:dartz/dartz.dart';
import 'package:unitalk/core/failure/failure.dart';
import 'package:unitalk/features/auth/data/datasource/user_remote_datasource.dart';
import 'package:unitalk/features/auth/data/model/user_model.dart';
import 'package:unitalk/features/auth/domain/repository/user_repository.dart';

class UserRepositoryImpl implements UserRepository {
  final UserRemoteDataSource remoteDataSource;

  UserRepositoryImpl(this.remoteDataSource);

  @override
  Future<Either<Failure, UserModel>> getCurrentUser() async {
    try {
      final user = await remoteDataSource.getCurrentUser();
      return Right(user);
    } catch (e) {
      return Left(ServerFailure(message: e.toString()));
    }
  }

  @override
  Future<Either<Failure, UserModel>> getUserById(String userId) async {
    try {
      final user = await remoteDataSource.getUserById(userId);
      return Right(user);
    } catch (e) {
      return Left(ServerFailure(message: e.toString()));
    }
  }

  @override
  Future<Either<Failure, UserModel>> updateProfile({
    required String firstName,
    required String lastName,
    required String universityId,
    required String facultyId,
    required Sector sector,
    String? language,
  }) async {
    try {
      final user = await remoteDataSource.updateProfile(
        firstName: firstName,
        lastName: lastName,
        universityId: universityId,
        facultyId: facultyId,
        sector: sector.code,
        language: language,
      );
      return Right(user);
    } catch (e) {
      return Left(ServerFailure(message: e.toString()));
    }
  }

  @override
  Future<Either<Failure, String>> updateAvatar(File file) async {
    try {
      final photoUrl = await remoteDataSource.updateAvatar(file: file);
      return Right(photoUrl);
    } catch (e) {
      return Left(ServerFailure(message: e.toString()));
    }
  }

  @override
  Future<Either<Failure, void>> deleteProfile() async {
    try {
      await remoteDataSource.deleteProfile();
      return const Right(null);
    } catch (e) {
      return Left(ServerFailure(message: e.toString()));
    }
  }
}import 'dart:io';
import 'package:dartz/dartz.dart';
import 'package:unitalk/core/failure/failure.dart';
import 'package:unitalk/features/auth/data/model/user_model.dart';

abstract class UserRepository {
  Future<Either<Failure, UserModel>> getCurrentUser();

  Future<Either<Failure, UserModel>> getUserById(String userId);

  Future<Either<Failure, UserModel>> updateProfile({
    required String firstName,
    required String lastName,
    required String universityId,
    required String facultyId,
    required Sector sector,
    String? language,
  });

  Future<Either<Failure, String>> updateAvatar(File file);

  Future<Either<Failure, void>> deleteProfile();
}