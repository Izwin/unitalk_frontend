import 'package:unitalk/features/auth/data/model/user_model.dart';
import 'package:unitalk/features/friendship/data/model/friendship_model.dart';

enum FriendshipStateStatus { initial, loading, success, failure, loadingMore }

class FriendshipState {
  final FriendshipStateStatus status;

  // –°–ø–∏—Å–∫–∏
  final List<UserModel> friends;
  final List<FriendRequestModel> incomingRequests;
  final List<FriendRequestModel> outgoingRequests;

  // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
  final int friendsPage;
  final int incomingPage;
  final int outgoingPage;
  final bool friendsHasMore;
  final bool incomingHasMore;
  final bool outgoingHasMore;

  // –°—Ç–∞—Ç—É—Å –¥—Ä—É–∂–±—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  final Map<String, FriendshipStatusResponse> friendshipStatuses;

  // –û—à–∏–±–∫–∏
  final String? errorMessage;

  FriendshipState({
    required this.status,
    this.friends = const [],
    this.incomingRequests = const [],
    this.outgoingRequests = const [],
    this.friendsPage = 1,
    this.incomingPage = 1,
    this.outgoingPage = 1,
    this.friendsHasMore = true,
    this.incomingHasMore = true,
    this.outgoingHasMore = true,
    this.friendshipStatuses = const {},
    this.errorMessage,
  });

  factory FriendshipState.initial() => FriendshipState(
    status: FriendshipStateStatus.initial,
  );

  FriendshipState copyWith({
    FriendshipStateStatus? status,
    List<UserModel>? friends,
    List<FriendRequestModel>? incomingRequests,
    List<FriendRequestModel>? outgoingRequests,
    int? friendsPage,
    int? incomingPage,
    int? outgoingPage,
    bool? friendsHasMore,
    bool? incomingHasMore,
    bool? outgoingHasMore,
    Map<String, FriendshipStatusResponse>? friendshipStatuses,
    String? errorMessage,
  }) {
    return FriendshipState(
      status: status ?? this.status,
      friends: friends ?? this.friends,
      incomingRequests: incomingRequests ?? this.incomingRequests,
      outgoingRequests: outgoingRequests ?? this.outgoingRequests,
      friendsPage: friendsPage ?? this.friendsPage,
      incomingPage: incomingPage ?? this.incomingPage,
      outgoingPage: outgoingPage ?? this.outgoingPage,
      friendsHasMore: friendsHasMore ?? this.friendsHasMore,
      incomingHasMore: incomingHasMore ?? this.incomingHasMore,
      outgoingHasMore: outgoingHasMore ?? this.outgoingHasMore,
      friendshipStatuses: friendshipStatuses ?? this.friendshipStatuses,
      errorMessage: errorMessage,
    );
  }

  // –ì–µ—Ç—Ç–µ—Ä—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  FriendshipStatusResponse? getFriendshipStatus(String userId) {
    return friendshipStatuses[userId];
  }

  bool get isLoading => status == FriendshipStateStatus.loading;
  bool get isLoadingMore => status == FriendshipStateStatus.loadingMore;
  bool get hasError => status == FriendshipStateStatus.failure;
}abstract class FriendshipEvent {}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–∂–±–æ–π
class SendFriendRequestEvent extends FriendshipEvent {
  final String userId;
  SendFriendRequestEvent(this.userId);
}

class AcceptFriendRequestEvent extends FriendshipEvent {
  final String friendshipId;
  AcceptFriendRequestEvent(this.friendshipId);
}

class RejectFriendRequestEvent extends FriendshipEvent {
  final String friendshipId;
  RejectFriendRequestEvent(this.friendshipId);
}

class RemoveFriendshipEvent extends FriendshipEvent {
  final String friendshipId;
  RemoveFriendshipEvent(this.friendshipId);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
class LoadFriendsListEvent extends FriendshipEvent {
  final bool loadMore;
  LoadFriendsListEvent({this.loadMore = false});
}

class LoadIncomingRequestsEvent extends FriendshipEvent {
  final bool loadMore;
  LoadIncomingRequestsEvent({this.loadMore = false});
}

class LoadOutgoingRequestsEvent extends FriendshipEvent {
  final bool loadMore;
  LoadOutgoingRequestsEvent({this.loadMore = false});
}

class LoadFriendshipStatusEvent extends FriendshipEvent {
  final String userId;
  LoadFriendshipStatusEvent(this.userId);
}

// –û—á–∏—Å—Ç–∫–∞
class ClearFriendshipStateEvent extends FriendshipEvent {}// lib/features/friendship/data/models/friendship_model.dart
import 'package:json_annotation/json_annotation.dart';
import 'package:unitalk/features/auth/data/model/user_model.dart';

part 'friendship_model.g.dart';

enum FriendshipStatus {
  @JsonValue('none')
  none,
  @JsonValue('pending')
  pending,
  @JsonValue('accepted')
  accepted,
  @JsonValue('rejected')
  rejected,
}

@JsonSerializable()
class FriendshipModel {
  @JsonKey(name: '_id')
  final String? id;
  final FriendshipStatus status;
  final String? friendshipId;
  final bool? isRequester;
  final DateTime? createdAt;
  final DateTime? acceptedAt;

  FriendshipModel({
    this.id,
    required this.status,
    this.friendshipId,
    this.isRequester,
    this.createdAt,
    this.acceptedAt,
  });

  factory FriendshipModel.fromJson(Map<String, dynamic> json) =>
      _$FriendshipModelFromJson(json);

  Map<String, dynamic> toJson() => _$FriendshipModelToJson(this);

  bool get isPending => status == FriendshipStatus.pending;
  bool get isAccepted => status == FriendshipStatus.accepted;
  bool get isNone => status == FriendshipStatus.none;
}

@JsonSerializable()
class FriendshipStatusResponse {
  final FriendshipStatus status;
  final bool isFriend;
  final String? friendshipId;
  final bool? isRequester;
  final DateTime? createdAt;
  final DateTime? acceptedAt;

  FriendshipStatusResponse({
    required this.status,
    required this.isFriend,
    this.friendshipId,
    this.isRequester,
    this.createdAt,
    this.acceptedAt,
  });

  factory FriendshipStatusResponse.fromJson(Map<String, dynamic> json) =>
      _$FriendshipStatusResponseFromJson(json);

  Map<String, dynamic> toJson() => _$FriendshipStatusResponseToJson(this);
}

@JsonSerializable()
class FriendRequestModel {
  final String friendshipId;
  final UserModel user;
  final DateTime requestedAt;

  FriendRequestModel({
    required this.friendshipId,
    required this.user,
    required this.requestedAt,
  });

  factory FriendRequestModel.fromJson(Map<String, dynamic> json) =>
      _$FriendRequestModelFromJson(json);

  Map<String, dynamic> toJson() => _$FriendRequestModelToJson(this);
}// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'friendship_model.dart';

// **************************************************************************
// JsonSerializableGenerator
// **************************************************************************

FriendshipModel _$FriendshipModelFromJson(Map<String, dynamic> json) =>
    FriendshipModel(
      id: json['_id'] as String?,
      status: $enumDecode(_$FriendshipStatusEnumMap, json['status']),
      friendshipId: json['friendshipId'] as String?,
      isRequester: json['isRequester'] as bool?,
      createdAt: json['createdAt'] == null
          ? null
          : DateTime.parse(json['createdAt'] as String),
      acceptedAt: json['acceptedAt'] == null
          ? null
          : DateTime.parse(json['acceptedAt'] as String),
    );

Map<String, dynamic> _$FriendshipModelToJson(FriendshipModel instance) =>
    <String, dynamic>{
      '_id': instance.id,
      'status': _$FriendshipStatusEnumMap[instance.status]!,
      'friendshipId': instance.friendshipId,
      'isRequester': instance.isRequester,
      'createdAt': instance.createdAt?.toIso8601String(),
      'acceptedAt': instance.acceptedAt?.toIso8601String(),
    };

const _$FriendshipStatusEnumMap = {
  FriendshipStatus.none: 'none',
  FriendshipStatus.pending: 'pending',
  FriendshipStatus.accepted: 'accepted',
  FriendshipStatus.rejected: 'rejected',
};

FriendshipStatusResponse _$FriendshipStatusResponseFromJson(
  Map<String, dynamic> json,
) => FriendshipStatusResponse(
  status: $enumDecode(_$FriendshipStatusEnumMap, json['status']),
  isFriend: json['isFriend'] as bool,
  friendshipId: json['friendshipId'] as String?,
  isRequester: json['isRequester'] as bool?,
  createdAt: json['createdAt'] == null
      ? null
      : DateTime.parse(json['createdAt'] as String),
  acceptedAt: json['acceptedAt'] == null
      ? null
      : DateTime.parse(json['acceptedAt'] as String),
);

Map<String, dynamic> _$FriendshipStatusResponseToJson(
  FriendshipStatusResponse instance,
) => <String, dynamic>{
  'status': _$FriendshipStatusEnumMap[instance.status]!,
  'isFriend': instance.isFriend,
  'friendshipId': instance.friendshipId,
  'isRequester': instance.isRequester,
  'createdAt': instance.createdAt?.toIso8601String(),
  'acceptedAt': instance.acceptedAt?.toIso8601String(),
};

FriendRequestModel _$FriendRequestModelFromJson(Map<String, dynamic> json) =>
    FriendRequestModel(
      friendshipId: json['friendshipId'] as String,
      user: UserModel.fromJson(json['user'] as Map<String, dynamic>),
      requestedAt: DateTime.parse(json['requestedAt'] as String),
    );

Map<String, dynamic> _$FriendRequestModelToJson(FriendRequestModel instance) =>
    <String, dynamic>{
      'friendshipId': instance.friendshipId,
      'user': instance.user,
      'requestedAt': instance.requestedAt.toIso8601String(),
    };
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_bloc.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_event.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_state.dart' show FriendshipState;
import 'package:unitalk/l10n/app_localizations.dart';

import '../../data/model/friendship_model.dart' show FriendshipStatus;

class FriendshipButton extends StatelessWidget {
  final String userId;
  final bool compact;

  const FriendshipButton({
    Key? key,
    required this.userId,
    this.compact = false,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;

    return BlocBuilder<FriendshipBloc, FriendshipState>(
      builder: (context, state) {
        final friendshipStatus = state.getFriendshipStatus(userId);

        if (friendshipStatus == null) {
          // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
          context.read<FriendshipBloc>().add(LoadFriendshipStatusEvent(userId));
          return const SizedBox.shrink();
        }

        final status = friendshipStatus.status;
        final isRequester = friendshipStatus.isRequester ?? false;
        final friendshipId = friendshipStatus.friendshipId;

        // –£–∂–µ –¥—Ä—É–∑—å—è
        if (status == FriendshipStatus.accepted) {
          return _buildButton(
            context: context,
            label: compact ? l10n.friends : l10n.removeFriend,
            icon: compact ? Icons.people : Icons.person_remove,
            backgroundColor: theme.cardColor,
            foregroundColor: theme.textTheme.bodyMedium?.color,
            borderColor: theme.dividerColor,
            onPressed: () {
              _showRemoveFriendDialog(context, friendshipId!);
            },
          );
        }

        // –û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞ (—Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–ø—Ä–æ—Å)
        if (status == FriendshipStatus.pending && isRequester) {
          return _buildButton(
            context: context,
            label: compact ? l10n.pending : l10n.cancelRequest,
            icon: compact ? Icons.schedule : Icons.close,
            backgroundColor: theme.cardColor,
            foregroundColor: theme.textTheme.bodyMedium?.color?.withOpacity(0.6),
            borderColor: theme.dividerColor,
            onPressed: () {
              context.read<FriendshipBloc>().add(
                RemoveFriendshipEvent(friendshipId!),
              );
            },
          );
        }

        // –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å (–¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–ø—Ä–æ—Å)
        if (status == FriendshipStatus.pending && !isRequester) {
          return Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              _buildButton(
                context: context,
                label: l10n.accept,
                icon: Icons.check,
                backgroundColor: theme.primaryColor,
                foregroundColor: Colors.white,
                onPressed: () {
                  context.read<FriendshipBloc>().add(
                    AcceptFriendRequestEvent(friendshipId!),
                  );
                },
              ),
              const SizedBox(width: 8),
              _buildButton(
                context: context,
                label: l10n.reject,
                icon: Icons.close,
                backgroundColor: theme.cardColor,
                foregroundColor: theme.textTheme.bodyMedium?.color,
                borderColor: theme.dividerColor,
                onPressed: () {
                  context.read<FriendshipBloc>().add(
                    RejectFriendRequestEvent(friendshipId!),
                  );
                },
              ),
            ],
          );
        }

        // –ù–µ—Ç –¥—Ä—É–∂–±—ã
        return _buildButton(
          context: context,
          label: compact ? l10n.add : l10n.addFriend,
          icon: compact ? Icons.person_add : Icons.person_add_outlined,
          backgroundColor: theme.primaryColor,
          foregroundColor: Colors.white,
          onPressed: () {
            context.read<FriendshipBloc>().add(
              SendFriendRequestEvent(userId),
            );
          },
        );
      },
    );
  }

  Widget _buildButton({
    required BuildContext context,
    required String label,
    required IconData icon,
    required Color backgroundColor,
    required Color? foregroundColor,
    Color? borderColor,
    required VoidCallback onPressed,
  }) {
    return compact
        ? IconButton.filled(
      onPressed: onPressed,
      icon: Icon(icon, size: 20),
      style: IconButton.styleFrom(
        backgroundColor: backgroundColor,
        foregroundColor: foregroundColor,
        side: borderColor != null
            ? BorderSide(color: borderColor)
            : null,
      ),
    )
        : ElevatedButton.icon(
      onPressed: onPressed,
      icon: Icon(icon, size: 18),
      label: Text(label),
      style: ElevatedButton.styleFrom(
        backgroundColor: backgroundColor,
        foregroundColor: foregroundColor,
        elevation: 0,
        side: borderColor != null
            ? BorderSide(color: borderColor)
            : null,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(8),
        ),
      ),
    );
  }

  void _showRemoveFriendDialog(BuildContext context, String friendshipId) {
    final l10n = AppLocalizations.of(context)!;
    final theme = Theme.of(context);

    showDialog(
      context: context,
      builder: (dialogContext) => AlertDialog(
        title: Text(l10n.removeFriend),
        content: Text(l10n.removeFriendConfirmation),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(dialogContext),
            child: Text(l10n.cancel),
          ),
          TextButton(
            onPressed: () {
              context.read<FriendshipBloc>().add(
                RemoveFriendshipEvent(friendshipId),
              );
              Navigator.pop(dialogContext);
            },
            style: TextButton.styleFrom(
              foregroundColor: theme.colorScheme.error,
            ),
            child: Text(l10n.remove),
          ),
        ],
      ),
    );
  }
}import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:unitalk/core/di/service_locator.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_bloc.dart';
import 'package:unitalk/features/auth/presentation/bloc/auth_state.dart';
import 'package:unitalk/features/block/presentation/bloc/block_bloc.dart';
import 'package:unitalk/features/block/presentation/bloc/block_event.dart';
import 'package:unitalk/features/block/presentation/bloc/block_state.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_bloc.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_event.dart';
import 'package:unitalk/features/feed/presentation/bloc/post/post_state.dart';
import 'package:unitalk/features/feed/presentation/bloc/user_profile/user_profile_bloc.dart';
import 'package:unitalk/features/feed/presentation/bloc/user_profile/user_profile_event.dart';
import 'package:unitalk/features/feed/presentation/bloc/user_profile/user_profile_state.dart';
import 'package:unitalk/features/feed/presentation/widget/post_item.dart';
import 'package:unitalk/features/auth/presentation/widget/student_id_card_widget.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_bloc.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_event.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_state.dart';
import 'package:unitalk/features/friendship/presentation/widgets/friendship_button.dart';
import 'package:unitalk/features/report/presentation/user_moderation_actions.dart';
import 'package:unitalk/l10n/app_localizations.dart';

class OtherUserProfileScreen extends StatefulWidget {
  final String userId;

  const OtherUserProfileScreen({
    Key? key,
    required this.userId,
  }) : super(key: key);

  @override
  State<OtherUserProfileScreen> createState() => _OtherUserProfileScreenState();
}

class _OtherUserProfileScreenState extends State<OtherUserProfileScreen> {
  late ScrollController _scrollController;

  @override
  void initState() {
    super.initState();
    _scrollController = ScrollController();
    _scrollController.addListener(_onScroll);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.read<UserProfileBloc>().add(GetUserProfileEvent(widget.userId));

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ PostBloc
    context.read<PostBloc>().add(GetPostsEvent(
      authorId: widget.userId,
      page: 1,
      limit: 20,
    ));

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    context.read<BlockBloc>().add(CheckBlockStatusEvent(widget.userId));
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  Future<void> _onRefresh() async {
    context.read<UserProfileBloc>().add(GetUserProfileEvent(widget.userId));
    context.read<BlockBloc>().add(CheckBlockStatusEvent(widget.userId));

    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã
    context.read<PostBloc>().add(GetPostsEvent(
      authorId: widget.userId,
      page: 1,
      limit: 20,
    ));

    await context.read<UserProfileBloc>().stream.firstWhere(
          (state) => !state.isLoading,
    );
  }

  void _onScroll() {
    if (_scrollController.position.pixels ==
        _scrollController.position.maxScrollExtent) {
      final postState = context.read<PostBloc>().state;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å—Ç—ã –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∏ –Ω–µ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞
      if (!postState.postsLastPage && !postState.isLoadingMore) {
        context.read<PostBloc>().add(GetPostsEvent(
          authorId: widget.userId,
          page: postState.postsPage + 1,
          limit: 20,
        ));
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return BlocProvider(
  create: (context) => sl<FriendshipBloc>()..add(LoadFriendshipStatusEvent(widget.userId)),
  child: Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: BlocBuilder<UserProfileBloc, UserProfileState>(
        builder: (context, profileState) {
          if (profileState.isLoading && profileState.user == null) {
            return const Center(child: CircularProgressIndicator());
          }

          if (profileState.errorMessage != null && profileState.user == null) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.error_outline,
                    size: 64,
                    color: Theme.of(context)
                        .textTheme
                        .bodySmall
                        ?.color
                        ?.withOpacity(0.3),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    l10n.errorMessage(profileState.errorMessage ?? ''),
                    style: TextStyle(
                      fontSize: 16,
                      color: Theme.of(context)
                          .textTheme
                          .bodySmall
                          ?.color
                          ?.withOpacity(0.6),
                    ),
                  ),
                  const SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: () {
                      context
                          .read<UserProfileBloc>()
                          .add(GetUserProfileEvent(widget.userId));
                    },
                    child: Text(l10n.tryAgain),
                  ),
                ],
              ),
            );
          }

          final user = profileState.user;
          if (user == null) {
            return Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Icon(
                    Icons.person_off_outlined,
                    size: 64,
                    color: Theme.of(context)
                        .textTheme
                        .bodySmall
                        ?.color
                        ?.withOpacity(0.3),
                  ),
                  const SizedBox(height: 16),
                  Text(
                    l10n.userNotFound,
                    style: TextStyle(
                      fontSize: 16,
                      color: Theme.of(context)
                          .textTheme
                          .bodySmall
                          ?.color
                          ?.withOpacity(0.6),
                    ),
                  ),
                ],
              ),
            );
          }

          return BlocBuilder<PostBloc, PostState>(
            builder: (context, postState) {
              return RefreshIndicator(
                onRefresh: _onRefresh,
                color: Theme.of(context).colorScheme.primary,
                backgroundColor: Theme.of(context).colorScheme.surface,
                child: CustomScrollView(
                  controller: _scrollController,
                  physics: const AlwaysScrollableScrollPhysics(),
                  slivers: [
                    // App Bar
                    SliverAppBar(
                      expandedHeight: 0,
                      pinned: false,
                      backgroundColor: Colors.transparent,
                      elevation: 0,
                      title: Text(l10n.profile),
                      leading: IconButton(
                        icon: const Icon(Icons.arrow_back),
                        onPressed: () => context.pop(),
                      ),
                    ),

                    // Profile Content
                    SliverPadding(
                      padding: const EdgeInsets.all(20),
                      sliver: SliverList(
                        delegate: SliverChildListDelegate([
                          // Student Card
                          StudentIdCardWidget(user: user),
                          const SizedBox(height: 24),

                          // Moderation Actions
                          BlocBuilder<AuthBloc, AuthState>(
                            builder: (context, authState) {
                              final currentUserId = authState.user?.id;
                              final isOwnProfile = currentUserId == widget.userId;

                              if (isOwnProfile) {
                                return const SizedBox.shrink();
                              }

                              return BlocConsumer<BlockBloc, BlockState>(
                                listener: (context, blockState) {
                                  context.read<UserProfileBloc>().add(
                                      GetUserProfileEvent(widget.userId));
                                },
                                builder: (context, blockState) {
                                  return Padding(
                                    padding: const EdgeInsets.symmetric(horizontal: 20),
                                    child: UserModerationActions(
                                      userId: widget.userId,
                                      blockStatus: user.blockStatus,
                                      userName: '${user.firstName} ${user.lastName}',
                                    ),
                                  );
                                },
                              );
                            },
                          ),
                          const SizedBox(height: 24),
                          BlocBuilder<FriendshipBloc, FriendshipState>(
                            builder: (context, friendshipState) {
                              print(friendshipState.friendshipStatuses);
                              final friendshipStatus = friendshipState.getFriendshipStatus(widget.userId);
                              print('asdasd');
                              print(friendshipStatus);
                              return FriendshipButton(
                                userId: widget.userId,
                              );
                            },
                          ),
                          // Posts Section Header
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                l10n.posts,
                                style: const TextStyle(
                                  fontSize: 20,
                                  fontWeight: FontWeight.bold,
                                ),
                              ),
                              Text(
                                l10n.postsCount(postState.posts.length),
                                style: TextStyle(
                                  fontSize: 14,
                                  color: Theme.of(context)
                                      .textTheme
                                      .bodySmall
                                      ?.color
                                      ?.withOpacity(0.6),
                                ),
                              ),
                            ],
                          ),
                        ]),
                      ),
                    ),

                    // Posts List
                    if (postState.posts.isEmpty && !postState.isLoading)
                      SliverFillRemaining(
                        child: Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(
                                Icons.article_outlined,
                                size: 64,
                                color: Theme.of(context)
                                    .textTheme
                                    .bodySmall
                                    ?.color
                                    ?.withOpacity(0.3),
                              ),
                              const SizedBox(height: 16),
                              Text(
                                l10n.userHasNoPosts,
                                textAlign: TextAlign.center,
                                style: TextStyle(
                                  fontSize: 16,
                                  color: Theme.of(context)
                                      .textTheme
                                      .bodySmall
                                      ?.color
                                      ?.withOpacity(0.6),
                                ),
                              ),
                            ],
                          ),
                        ),
                      )
                    else
                      SliverList(
                        delegate: SliverChildBuilderDelegate(
                              (context, index) {
                            final post = postState.posts[index];
                            return PostItem(post: post);
                          },
                          childCount: postState.posts.length,
                        ),
                      ),

                    // Loading More Indicator
                    if (postState.isLoadingMore)
                      const SliverToBoxAdapter(
                        child: Padding(
                          padding: EdgeInsets.all(16),
                          child: Center(
                            child: CircularProgressIndicator(),
                          ),
                        ),
                      ),

                    // Bottom Padding
                    const SliverPadding(padding: EdgeInsets.only(bottom: 40)),
                  ],
                ),
              );
            },
          );
        },
      ),
    ),
);
  }
}import 'package:json_annotation/json_annotation.dart';
import 'package:unitalk/features/block/data/model/block_model.dart';
import 'package:unitalk/features/faculty/data/models/faculty_model.dart';
import 'package:unitalk/features/university/data/models/university_model.dart';
import 'verification_model.dart';

part 'user_model.g.dart';

enum Sector {
  @JsonValue('en')
  english,
  @JsonValue('ru')
  russian,
  @JsonValue('az')
  azerbaijani;

  String get code {
    switch (this) {
      case Sector.english:
        return 'en';
      case Sector.russian:
        return 'ru';
      case Sector.azerbaijani:
        return 'az';
    }
  }

  String get displayName {
    switch (this) {
      case Sector.english:
        return 'English';
      case Sector.russian:
        return 'Russian';
      case Sector.azerbaijani:
        return 'Azerbaijani';
    }
  }

  String get flagEmoji {
    switch (this) {
      case Sector.english:
        return 'üá¨üáß';
      case Sector.russian:
        return 'üá∑üá∫';
      case Sector.azerbaijani:
        return 'üá¶üáø';
    }
  }

  static Sector? fromCode(String? code) {
    if (code == null) return null;
    switch (code) {
      case 'en':
        return Sector.english;
      case 'ru':
        return Sector.russian;
      case 'az':
        return Sector.azerbaijani;
      default:
        return null;
    }
  }
}

@JsonSerializable()
class UserModel {
  @JsonKey(name: '_id')
  final String? id;
  final String? email;
  final String? photoUrl;
  final String? firstName;
  final String? lastName;
  @JsonKey(name: 'universityId')
  final UniversityModel? university;
  @JsonKey(name: 'facultyId')
  final FacultyModel? faculty;
  final Sector? sector;
  final bool? isVerified;
  @JsonKey(name: 'verificationId')
  final VerificationModel? verification;
  final BlockStatusModel? blockStatus;
  final int? friendsCount;
  final int? pendingRequestsCount;

  // –ù–û–í–û–ï: –Ø–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
  final String? language;

  UserModel({
    required this.id,
    this.email,
    this.photoUrl,
    this.firstName,
    this.lastName,
    this.university,
    this.faculty,
    this.sector,
    this.isVerified,
    this.verification,
    this.blockStatus,
    this.friendsCount,
    this.pendingRequestsCount,
    this.language, // –ù–û–í–û–ï
  });

  factory UserModel.fromJson(Map<String, dynamic> json) =>
      _$UserModelFromJson(json);

  Map<String, dynamic> toJson() => _$UserModelToJson(this);

  bool get isProfileComplete =>
      firstName != null &&
          lastName != null &&
          university != null &&
          faculty != null &&
          sector != null;

  bool get canInteract => blockStatus?.canInteract ?? true;
  bool get isBlocked => blockStatus?.isBlocked ?? false;
  bool get isBlockedBy => blockStatus?.isBlockedBy ?? false;
}import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:unitalk/core/ui/common/empty_state_widget.dart';
import 'package:unitalk/core/ui/common/user_avatar.dart';
import 'package:unitalk/core/ui/common/user_meta_info.dart';
import 'package:unitalk/features/auth/data/model/user_model.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_bloc.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_event.dart';
import 'package:unitalk/features/friendship/presentation/bloc/friendship_state.dart';
import 'package:unitalk/features/friendship/presentation/widgets/friendship_button.dart';
import 'package:unitalk/features/search/presentation/bloc/user_search_bloc.dart';
import 'package:unitalk/features/search/presentation/bloc/user_search_event.dart';
import 'package:unitalk/features/search/presentation/bloc/user_search_state.dart';
import 'package:unitalk/l10n/app_localizations.dart';

class UserSearchPage extends StatefulWidget {
  const UserSearchPage({Key? key}) : super(key: key);

  @override
  State<UserSearchPage> createState() => _UserSearchPageState();
}

class _UserSearchPageState extends State<UserSearchPage> {
  final TextEditingController _searchController = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  final FocusNode _searchFocus = FocusNode();

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_onScroll);
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _searchFocus.requestFocus();
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    _scrollController.dispose();
    _searchFocus.dispose();
    super.dispose();
  }

  // –ó–∞–º–µ–Ω–∏—Ç–µ –º–µ—Ç–æ–¥ _onScroll –≤ UserSearchPage –Ω–∞ —ç—Ç–æ—Ç:

  void _onScroll() {
    if (_isBottom) {
      final state = context.read<UserSearchBloc>().state;

      // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
      if (state.hasMore &&
          state.status != UserSearchStatus.loadingMore &&
          state.status != UserSearchStatus.loading) {

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print('Loading more users. Current count: ${state.users.length}, Total: ${state.total}');

        context.read<UserSearchBloc>().add(SearchUsersEvent(
          query: _searchController.text,
          loadMore: true,
        ));
      }
    }
  }

  bool get _isBottom {
    if (!_scrollController.hasClients) return false;
    final maxScroll = _scrollController.position.maxScrollExtent;
    final currentScroll = _scrollController.offset;
    // –ú–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥ —Å 0.9 –Ω–∞ 0.8 –¥–ª—è –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
    return currentScroll >= (maxScroll * 0.85);
  }


  void _onSearchChanged(String value) {
    if (value.trim().length >= 2) {
      context.read<UserSearchBloc>().add(SearchUsersEvent(query: value));
    } else if (value.trim().isEmpty) {
      context.read<UserSearchBloc>().add(ClearSearchEvent());
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: theme.scaffoldBackgroundColor,
      appBar: AppBar(
        elevation: 0,
        backgroundColor: theme.scaffoldBackgroundColor,
        surfaceTintColor: theme.scaffoldBackgroundColor,
        title: Text(
          l10n.searchUsers,
          style: TextStyle(
            color: theme.textTheme.titleLarge?.color,
            fontSize: 20,
            fontWeight: FontWeight.w600,
          ),
        ),
      ),
      body: Column(
        children: [
          _buildSearchBar(l10n),
          Expanded(child: _buildBody(l10n)),
        ],
      ),
    );
  }

  Widget _buildSearchBar(AppLocalizations l10n) {
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;

    return Container(
      padding: const EdgeInsets.fromLTRB(16, 8, 16, 16),
      decoration: BoxDecoration(
        color: theme.scaffoldBackgroundColor,
        border: Border(
          bottom: BorderSide(
            color: theme.dividerColor.withOpacity(0.1),
          ),
        ),
      ),
      child: TextField(
        controller: _searchController,
        focusNode: _searchFocus,
        onChanged: _onSearchChanged,
        style: TextStyle(color: theme.textTheme.bodyLarge?.color),
        decoration: InputDecoration(
          hintText: l10n.searchUsersByName,
          hintStyle: TextStyle(
            color: theme.textTheme.bodySmall?.color?.withOpacity(0.4),
            fontSize: 15,
          ),
          prefixIcon: Icon(
            Icons.search,
            color: theme.textTheme.bodySmall?.color?.withOpacity(0.4),
          ),
          suffixIcon: _searchController.text.isNotEmpty
              ? IconButton(
            icon: Icon(
              Icons.clear,
              color: theme.textTheme.bodySmall?.color?.withOpacity(0.4),
            ),
            onPressed: () {
              _searchController.clear();
              _onSearchChanged('');
            },
          )
              : null,
          filled: true,
          fillColor: isDark
              ? theme.cardColor.withOpacity(0.3)
              : theme.textTheme.bodySmall?.color?.withOpacity(0.05),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide.none,
          ),
          contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        ),
      ),
    );
  }

  Widget _buildBody(AppLocalizations l10n) {
    final theme = Theme.of(context);

    return BlocBuilder<UserSearchBloc, UserSearchState>(
      builder: (context, state) {
        if (state.status == UserSearchStatus.initial) {
          return EmptyStateWidget(
            icon: Icons.search,
            title: l10n.searchForUsers,
            subtitle: l10n.typeToStartSearching,
          );
        }

        if (state.status == UserSearchStatus.loading) {
          return Center(
            child: CircularProgressIndicator(
              strokeWidth: 2,
              color: theme.primaryColor,
            ),
          );
        }

        if (state.status == UserSearchStatus.failure) {
          return EmptyStateWidget(
            icon: Icons.error_outline,
            title: state.errorMessage ?? l10n.anErrorOccurred,
            subtitle: null,
          );
        }

        if (state.users.isEmpty) {
          return EmptyStateWidget(
            icon: Icons.person_off_outlined,
            title: l10n.noUsersFound,
            subtitle: l10n.tryDifferentName,
          );
        }

        print( 'afasdas ${state.total}');
        return Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Padding(
              padding: const EdgeInsets.fromLTRB(16, 16, 16, 8),
              child: Text(
                l10n.usersFound(state.total),
                style: TextStyle(
                  fontSize: 13,
                  color: theme.textTheme.bodySmall?.color?.withOpacity(0.6),
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
            Expanded(
              child: ListView.separated(
                controller: _scrollController,
                padding: const EdgeInsets.only(bottom: 16),
                itemCount: state.users.length + (state.hasMore ? 1 : 0),
                separatorBuilder: (context, index) => Divider(
                  height: 1,
                  color: theme.dividerColor.withOpacity(0.1),
                  indent: 76,
                ),
                itemBuilder: (context, index) {
                  if (index >= state.users.length) {
                    return Padding(
                      padding: const EdgeInsets.all(16),
                      child: Center(
                        child: SizedBox(
                          width: 24,
                          height: 24,
                          child: CircularProgressIndicator(
                            strokeWidth: 2,
                            color: theme.primaryColor,
                          ),
                        ),
                      ),
                    );
                  }

                  final user = state.users[index];
                  return _buildUserTile(user);
                },
              ),
            ),
          ],
        );
      },
    );
  }

  Widget _buildUserTile(UserModel user) {
    final theme = Theme.of(context);
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<FriendshipBloc>().add(LoadFriendshipStatusEvent(user.id!));
    });
    return InkWell(
      onTap: () {
        context.push('/user/${user.id}');
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        child: Row(
          children: [
            UserAvatar(
              photoUrl: user.photoUrl,
              firstName: user.firstName,
              lastName: user.lastName,
              size: 48,
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Flexible(
                        child: Text(
                          '${user.firstName ?? ''} ${user.lastName ?? ''}'.trim(),
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: theme.textTheme.titleLarge?.color,
                          ),
                          overflow: TextOverflow.ellipsis,
                        ),
                      ),
                      if (user.isVerified == true) ...[
                        const SizedBox(width: 4),
                        Icon(
                          Icons.verified,
                          size: 16,
                          color: theme.primaryColor,
                        ),
                      ],
                    ],
                  ),
                  if (user.university != null || user.faculty != null) ...[
                    const SizedBox(height: 4),
                    UserMetaInfo(
                      faculty: user.faculty?.getLocalizedName(
                        Localizations.localeOf(context).languageCode,
                      ),
                      sector: user.sector,
                      fontSize: 13,
                    ),
                  ],
                ],
              ),
            ),
            // ‚úÖ –î–û–ë–ê–í–¨–¢–ï –≠–¢–û:
            BlocBuilder<FriendshipBloc, FriendshipState>(
              builder: (context, state) {
                return FriendshipButton(
                  userId: user.id!,
                  compact: true,
                );
              },
            ),
          ],
        ),
      ),
    );
  }}